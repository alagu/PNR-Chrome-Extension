<!DOCTYPE html>
<html>
<head>
<script src="http://code.jquery.com/jquery-1.4.2.js"></script>
<script src="user.js"></script>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24995053-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = 'https://ssl.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script>

    /* Get stored PNR*/
    function getStoredPNR()
    {
        var pnrnum = localStorage['pnrnum']; 

        pnrnum = pnrnum ? pnrnum.split(',') : [];
        return pnrnum;
    }


    function trackEvent(event)
    {
        _gaq.push(['_trackEvent', event, 'event']);
    }

  function getJSON(url, callback) {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", url, true);
      xhr.onreadystatechange = function() {
          if (xhr.readyState == 4) {
              var resp = xhr.responseText;
              callback(resp);
          }
      }
      xhr.send();  
  }
    
  function onRequest(request, sender, callback) {
    if (request.action == 'getJSON') {
      getJSON(request.url, callback);
    }
    else if ( request.action == 'storePNR')
    {

       var pnrnum = getStoredPNR();
       var num = request.pnr_num_store + '';

       if(num.length == 10 && pnrnum.indexOf(num) == -1)
       {
         pnrnum.push(num);
       }

       localStorage['pnrnum'] = pnrnum.join(',');
       
       callback(num);
    }
    else if (request.action == 'getStoredPNR')
    {
        callback(getStoredPNR());
    }
    else if (request.action == 'track')
    {
        _gaq.push(['_trackEvent', request.event, 'event']);
    }
  }
    chrome.extension.onRequest.addListener(onRequest);


 /* Post install stuff */
  function install_notice() {
      if (localStorage.getItem('install_time'))
      {
          return;
      }

      var now = new Date().getTime();
      localStorage.setItem('install_time', now);
      chrome.tabs.create({url: "installed.html"});
  }
  install_notice();
  
var Background = {};

(function(){
  // If notification is enabled.
  if (window.webkitNotifications) {
      
      
      Background.show = function(data) {
        var status = '';
        for (var passenger in data['data']['passenger']) {
            var passengerStatus = data['data']['passenger'][passenger]['status']; 
            status += passengerStatus + ' ';
        }
        
        if (data['data']['from']['time'] != '') {
            status += '. Departs at ' + data['data']['from']['time'];
        }
        
        var notification = window.webkitNotifications.createNotification(
          'icon.png',                      // The image.
          'Today: ' + data['data']['from']['name'] + ' to ' + data['data']['to']['name'], // The title.
          'Status - ' + status       // The body.
        );
        
        notification.show();

        setTimeout(function() {
            notification.cancel();
        }, 20000);
      }


      Background.refreshTicket = function(pnr, data) {
          if(data){
              if(data.hasOwnProperty('data')) //Ticket data already exists.
              {
                  PNRStatus.todayTickets[pnr] = data;
                  Background.show(data);
              }
          }
          else
          {
             PNRStatus.getPNRStatus(pnr,function(new_data){ Background.refreshTicket(pnr, $.parseJSON(new_data)); }) 
          }
      }
      
      Background.refreshTodayTickets = function() {
          for (var pnrnum in PNRStatus.todayTickets) {
              Background.refreshTicket(pnrnum);
          }
      }


      Background.updateTodayTickets = function(force)
      {
          /* Last tickets updated */

          var lastTodayTicketCheck                       = localStorage.getItem('lastTodayTicketCheck');
          if(!lastTodayTicketCheck) lastTodayTicketCheck = 0;
          var currentTime                                = (new Date().getTime())/1000;
          var currentDate                                = (new Date());

          if(currentTime - lastTodayTicketCheck > 43200 || force) //Half a day
          {  
              var today = currentDate.getDate() + "-" + (currentDate.getMonth() + 1) + "-" + currentDate.getFullYear();

              /* Pick all the tickets for today and push it to localStorage. Cache the results. */
              var callback = function(data) {
                  var json = $.parseJSON(data);
                  console.log(json);
                  if(json.hasOwnProperty('data') && json['data'].hasOwnProperty('travel_date')) {

                      var ticketDate = (json['data']['travel_date']['date']);
                      if (ticketDate == today) {
                          PNRStatus.todayTickets[json['data']['pnr_number']] = {};
                          Background.refreshTicket(json['data']['pnr_number'],json);
                      }
                  }
              }
              
              PNRStatus.populatePNR();
              PNRStatus.fetchAll(callback); 
          }
      }  
    
    Background.updateTodayTickets();
    
    setInterval(Background.updateTodayTickets,6*3600*1000);//Update today's tickets every 12 hours. 
    setInterval(Background.refreshTodayTickets, 60*1000);
  }
})();

</script>

</head>
<body>
</body>
</html>
