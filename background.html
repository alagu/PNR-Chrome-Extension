<!DOCTYPE html>
<html>
<head>
<script src="http://code.jquery.com/jquery-1.4.2.js"></script>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24995053-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = 'https://ssl.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script>

    /* Get stored PNR*/
    function getStoredPNR()
    {
        var pnrnum = localStorage['pnrnum']; 

        pnrnum = pnrnum ? pnrnum.split(',') : [];
        return pnrnum;
    }


    function trackEvent(event)
    {
        _gaq.push(['_trackEvent', event, 'event']);
    }

    
  function onRequest(request, sender, callback) {
    if (request.action == 'getJSON') {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", request.url, true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          var resp = xhr.responseText;
          callback(resp);
        }
      }
      xhr.send();
    }
    else if ( request.action == 'storePNR')
    {

       var pnrnum = getStoredPNR();
       var num = request.pnr_num_store + '';

       if(num.length == 10 && pnrnum.indexOf(num) == -1)
       {
         pnrnum.push(num);
       }

       localStorage['pnrnum'] = pnrnum.join(',');
       
       callback(num);
    }
    else if (request.action == 'getStoredPNR')
    {
        callback(getStoredPNR());
    }
    else if (request.action == 'track')
    {
        _gaq.push(['_trackEvent', request.event, 'event']);
    }
  }
    chrome.extension.onRequest.addListener(onRequest);


 /* Post install stuff */
  function install_notice() {
      if (localStorage.getItem('install_time'))
      {
          return;
      }

      var now = new Date().getTime();
      localStorage.setItem('install_time', now);
      chrome.tabs.create({url: "installed.html"});
  }
  install_notice();

</script>

</head>
<body>
</body>
</html>
